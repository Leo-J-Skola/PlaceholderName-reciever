<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>StreamWeave Receiver (Web Page Loader)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; color:#ddd; font-family:Segoe UI, Roboto, Arial, sans-serif; }
    #main  { position:absolute; inset:0; }
    #a, #b { position:absolute; inset:0; width:100%; height:100%; border:0; background:#000; opacity:0; transition:opacity .25s ease; }
    .show  { opacity:1; }
    #splash { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#aaa; }
    #status { position:absolute; left:0; right:0; bottom:0; padding:8px 12px; background:rgba(0,0,0,.55); font-size:13px; }
  </style>
</head>
<body>
  <div id="splash">Waiting for URLâ€¦</div>
  <div id="main">
    <iframe id="a" allow="autoplay; fullscreen"></iframe>
    <iframe id="b" allow="autoplay; fullscreen"></iframe>
  </div>
  <div id="status"></div>
  <script>
    const NAMESPACE = 'urn:x-cast:streamweave.cast';
    const FORCE_DEFAULT = false;
    const forceQS = new URLSearchParams(location.search).get('force');
    let forceDisplay = FORCE_DEFAULT || forceQS === '1' || forceQS === 'true';
    const statusEl = document.getElementById('status');
    const splashEl = document.getElementById('splash');
    const iframeA  = document.getElementById('a');
    const iframeB  = document.getElementById('b');
    let current = iframeA;
    let candidate = iframeB;
    let reloadTimer = null;

    function setStatus(msg) { statusEl.textContent = msg || ''; }
    function swapIframes() {
      try {
        candidate.classList.add('show');
        current.classList.remove('show');
        const tmp = current; current = candidate; candidate = tmp;
      } catch {}
    }

    function loadInIframe(url) {
      clearTimeout(reloadTimer);
      setStatus('Loading: ' + url);
      splashEl.style.display = 'none';
      candidate.classList.remove('show');
      candidate.src = 'about:blank';
      setTimeout(() => {
        candidate.onload = () => {
          setStatus('Opened page: ' + url);
          swapIframes();
          candidate.onload = null;
        };
        candidate.src = url;
      }, 0);
    }

    function forceNavigate(url) {
      setStatus('Force loading: ' + url);
      splashEl.style.display = 'none';
      setTimeout(() => { window.location.href = url; }, 250);
    }

    const context = cast.framework.CastReceiverContext.getInstance();
    // context.setInactivityTimeout(3600);

    context.addCustomMessageListener(NAMESPACE, (event) => {
      try {
        const data = typeof event.data === 'string' ? JSON.parse(event.data) : (event.data || {});
        if (!data || data.type !== 'LOAD_URL' || !data.url) {
          setStatus('Invalid LOAD_URL payload');
          return;
        }
        const url = String(data.url);
        const useForce = (typeof data.force === 'boolean') ? data.force : forceDisplay;

        if (useForce) forceNavigate(url);
        else          loadInIframe(url);
      } catch (ex) {
        setStatus('Error: ' + (ex && ex.message ? ex.message : ex));
      }
    });
    context.start();

    window.addEventListener('keydown', (e) => {
      if ((e.key || '').toLowerCase() === 'f') {
        forceDisplay = !forceDisplay;
        setStatus('Force Display is now ' + (forceDisplay ? 'ON' : 'OFF'));
      }
    });
  </script>
</body>
</html>
